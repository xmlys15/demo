// ã€1. è·å–å‚æ•°ã€‘
// ä» Sub-Store ä¼ å…¥çš„å…¨å±€å˜é‡ $arguments ä¸­è§£æ„å‡º type å’Œ nameã€‚
// è¿™ä¸¤ä¸ªå€¼æ¥è‡ªäºä½ æ‰‹åŠ¨åœ¨ URL æœ«å°¾æ·»åŠ çš„ #type=...&name=...
const { type, name } = $arguments;

// ã€2. å®šä¹‰å¤‡ç”¨å‡ºç«™ã€‘
// å®šä¹‰ä¸€ä¸ªâ€œç›´è¿â€å‡ºç«™ï¼Œä½œä¸ºåå¤‡ã€‚å¦‚æœæŸä¸ªåˆ†ç»„æ²¡åŒ¹é…åˆ°ä»»ä½•èŠ‚ç‚¹ï¼Œå°±ç”¨å®ƒå¡«å……ï¼Œé˜²æ­¢å‡ºé”™ã€‚
const fallbackOutbound = {
  tag: 'COMPATIBLE',
  type: 'direct',
};

// ã€3. åŠ è½½é…ç½®æ–‡ä»¶ã€‘
// $files[0] åŒ…å«äº†ä½ ä½œä¸ºæ¨¡æ¿æä¾›çš„é‚£ä¸ªå®Œæ•´é…ç½®æ–‡ä»¶çš„å†…å®¹ã€‚
// è¿™é‡ŒæŠŠå®ƒä»æ–‡æœ¬è§£ææˆä¸€ä¸ª JavaScript å¯¹è±¡ï¼Œæ–¹ä¾¿åç»­æ“ä½œã€‚
let config = JSON.parse($files[0]);

// ã€4. è·å–æ‰€æœ‰èŠ‚ç‚¹ã€‘
// æ ¹æ®ä¼ å…¥çš„ name å’Œ typeï¼Œè°ƒç”¨ Sub-Store çš„æ ¸å¿ƒå‡½æ•° produceArtifact æ¥è·å–è®¢é˜…é“¾æ¥ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ã€‚
// produceArtifact ä¼šè¿”å›ä¸€ä¸ªåŒ…å«æ‰€æœ‰èŠ‚ç‚¹å¯¹è±¡çš„æ•°ç»„ã€‚
let proxies = await produceArtifact({
  name,
  type: /^1$|col/i.test(type) ? 'collection' : 'subscription', // æ­£åˆ™åˆ¤æ–­æ˜¯ç»„åˆè®¢é˜…è¿˜æ˜¯å•ä¸ªè®¢é˜…
  platform: 'sing-box',
  produceType: 'internal',
});

// ã€5. å…³é”®æ­¥éª¤ä¸€ï¼šæ³¨å…¥æ‰€æœ‰èŠ‚ç‚¹å®šä¹‰ã€‘
// å°†è·å–åˆ°çš„æ‰€æœ‰èŠ‚ç‚¹å¯¹è±¡ï¼ˆproxiesï¼‰å®Œæ•´åœ°æ·»åŠ åˆ°é…ç½®æ–‡ä»¶çš„ outbounds æ•°ç»„æœ«å°¾ã€‚
// è¿™ä¸€æ­¥è‡³å…³é‡è¦ï¼Œå®ƒä½¿å¾—æ‰€æœ‰èŠ‚ç‚¹åœ¨æœ€ç»ˆçš„é…ç½®æ–‡ä»¶ä¸­éƒ½æœ‰äº†å®šä¹‰ï¼Œè¿™æ ·åç»­æ‰èƒ½é€šè¿‡åå­—å¼•ç”¨å®ƒä»¬ã€‚
config.outbounds.push(...proxies);

// ã€6. æ ¸å¿ƒæ­¥éª¤ï¼šå®šä¹‰åˆ†ç»„è§„åˆ™å¹¶å¡«å……ã€‘
// åˆ›å»ºä¸€ä¸ªâ€œåˆ†ç»„åœ°å›¾â€ï¼Œé”®æ˜¯ä½ åœ¨é…ç½®æ–‡ä»¶é‡Œå®šä¹‰çš„ç­–ç•¥ç»„çš„ tagï¼Œå€¼æ˜¯ç”¨äºåŒ¹é…èŠ‚ç‚¹åå­—çš„æ­£åˆ™è¡¨è¾¾å¼ã€‚
const groupMap = {
  'ğŸš€ é»˜è®¤å‡ºç«™': /./, // /./ è¡¨ç¤ºåŒ¹é…æ‰€æœ‰å­—ç¬¦ï¼Œå³æ‰€æœ‰èŠ‚ç‚¹
  'ğŸ‡­ğŸ‡° é¦™æ¸¯èŠ‚ç‚¹': /æ¸¯|hk|hongkong|ğŸ‡­ğŸ‡°/i, // /i è¡¨ç¤ºä¸åŒºåˆ†å¤§å°å†™
  'ğŸ‡¼ğŸ‡¸ å°æ¹¾èŠ‚ç‚¹': /å°|tw|taiwan|ğŸ‡¹ğŸ‡¼/i,
  'ğŸ‡¯ğŸ‡µ æ—¥æœ¬èŠ‚ç‚¹': /æ—¥æœ¬|jp|japan|ğŸ‡¯ğŸ‡µ/i,
  'ğŸ‡ºğŸ‡² ç¾å›½èŠ‚ç‚¹': /ç¾|us|united\s?states|ğŸ‡ºğŸ‡¸/i, // \s? è¡¨ç¤ºå¯èƒ½æœ‰ç©ºæ ¼ä¹Ÿå¯èƒ½æ²¡æœ‰
  'ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡èŠ‚ç‚¹': /æ–°|sg|singapore|ğŸ‡¸ğŸ‡¬/i,
  'ğŸ“Œ å•é€‰èŠ‚ç‚¹': /^.*$/, // /^.*$/ ä¹Ÿæ˜¯åŒ¹é…æ‰€æœ‰èŠ‚ç‚¹çš„æ„æ€
};

// éå†é…ç½®æ–‡ä»¶ä¸­çš„æ¯ä¸€ä¸ªå‡ºç«™è§„åˆ™ï¼ˆåŒ…æ‹¬ä½ é¢„è®¾çš„ç­–ç•¥ç»„å’Œåˆšåˆšæ·»åŠ çš„èŠ‚ç‚¹ï¼‰
config.outbounds.forEach(group => {
  // å¦‚æœè¿™ä¸ªå‡ºç«™è§„åˆ™ä¸æ˜¯ä¸€ä¸ªæ•°ç»„ï¼ˆæ¯”å¦‚å®ƒæ˜¯ä¸€ä¸ªèŠ‚ç‚¹è€Œä¸æ˜¯ç­–ç•¥ç»„ï¼‰ï¼Œå°±è·³è¿‡
  if (!Array.isArray(group.outbounds)) return;

  // æ ¹æ®å½“å‰ç­–ç•¥ç»„çš„ tag (ä¾‹å¦‚ 'ğŸ‡­ğŸ‡° é¦™æ¸¯èŠ‚ç‚¹')ï¼Œå» groupMap é‡ŒæŸ¥æ‰¾å¯¹åº”çš„æ­£åˆ™è¡¨è¾¾å¼
  const regex = groupMap[group.tag];
  // è°ƒç”¨ä¸‹é¢çš„ getTags å‡½æ•°ï¼Œæ ¹æ®æ­£åˆ™è¡¨è¾¾å¼ç­›é€‰å‡ºæ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„èŠ‚ç‚¹çš„ â€œåå­—(tag)â€
  const tags = getTags(proxies, regex);
  // å°†ç­›é€‰å‡ºçš„èŠ‚ç‚¹åå­—ï¼Œæ·»åŠ åˆ°å½“å‰ç­–ç•¥ç»„çš„ outbounds æ•°ç»„ä¸­
  group.outbounds = tags;
});

// ã€7. æ”¶å°¾å·¥ä½œï¼šå¤„ç†ç©ºåˆ†ç»„ã€‘
// å†æ¬¡éå†æ‰€æœ‰ç­–ç•¥ç»„ï¼Œç¡®ä¿æ²¡æœ‰â€œç©ºâ€ç»„
config.outbounds.forEach(group => {
  // å¦‚æœä¸€ä¸ªç»„çš„ outbounds æ•°ç»„è¿˜æ˜¯ç©ºçš„ (é•¿åº¦ä¸º0)
  if (Array.isArray(group.outbounds) && group.outbounds.length === 0) {
    // æ£€æŸ¥å¤‡ç”¨çš„â€œç›´è¿â€å‡ºç«™æ˜¯å¦å·²å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œå°±æ·»åŠ è¿›å»
    if (!config.outbounds.find(o => o.tag === fallbackOutbound.tag)) {
      config.outbounds.push(fallbackOutbound);
    }
    // æŠŠå¤‡ç”¨å‡ºç«™çš„åå­—æ·»åŠ åˆ°è¿™ä¸ªç©ºç»„é‡Œï¼Œé˜²æ­¢å®¢æˆ·ç«¯å‡ºé”™
    group.outbounds.push(fallbackOutbound.tag);
  }
});

// ã€8. è¾“å‡ºæœ€ç»ˆç»“æœã€‘
// å°†è¢«æˆ‘ä»¬ä¿®æ”¹å¾—éå¸¸å®Œç¾çš„ config å¯¹è±¡ï¼Œè½¬æ¢å› JSON æ–‡æœ¬æ ¼å¼ã€‚
// $content æ˜¯ Sub-Store çš„ä¸€ä¸ªç‰¹æ®Šå˜é‡ï¼Œå®ƒçš„å€¼å°±æ˜¯æœ€ç»ˆç”Ÿæˆçš„é…ç½®æ–‡ä»¶å†…å®¹ã€‚
$content = JSON.stringify(config, null, 2);

// ã€è¾…åŠ©å‡½æ•°ã€‘
// ä¸€ä¸ªç”¨äºç­›é€‰èŠ‚ç‚¹å¹¶è¿”å›èŠ‚ç‚¹åå­—çš„å‡½æ•°
function getTags(proxies, regex) {
  return proxies
    // å¦‚æœæ²¡æœ‰æä¾›æ­£åˆ™è¡¨è¾¾å¼(regexä¸ºnull/undefined)ï¼Œæˆ–è€…æ­£åˆ™è¡¨è¾¾å¼èƒ½åŒ¹é…èŠ‚ç‚¹åå­—(p.tag)
    .filter(p => !regex || regex.test(p.tag)) 
    // è¿”å›æ‰€æœ‰ç­›é€‰åèŠ‚ç‚¹çš„ tag å±æ€§ï¼ˆå³èŠ‚ç‚¹åå­—ï¼‰
    .map(p => p.tag);
}